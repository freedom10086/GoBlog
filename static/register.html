<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>注册</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="styles/bootstrap.css">
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

<div class="card">
    <div class="card-header">注册</div>
    <form class="card-body" method="post" onsubmit="return validInput();">
        <div class="form-group">
            <label for="username">用户名</label>
            <input type="text" name="username" required id="username" placeholder="用户名" minlength="3"
                   maxlength="20" class="form-control"
                   autocomplete="name">
            <small class="form-text text-muted">最短3个字符,最长不超过20个字符</small>
        </div>

        <div class="form-group">
            <label for="email">邮箱</label>
            <input type="email" name="email" required id="email" placeholder="邮箱"
                   autocomplete="email" maxlength="25" list="email-hint" class="form-control">
            <datalist id="email-hint">
            </datalist>
            <small class="form-text text-muted">Example help text that remains unchanged.</small>
        </div>

        <div class="form-group">
            <label for="valid">验证码</label>
            <div class="flex-row" style="display: flex">
                <input id="valid" placeholder="验证码" required style="flex-grow: 2;flex-basis: 100px" type="text"
                       pattern="[a-zA-Z\d]{4}" maxlength="4" class="form-control">
                <canvas id="validcanvas" width="100" height="28"
                        style="border: 1px solid #ddd;margin-left: 12px;flex-grow: 1">
                    你的浏览器不支持canvas请使用chrome或者firefox浏览器
                </canvas>
            </div>
        </div>

        <div class="form-check">
            <label class="custom-control custom-checkbox">
                <input type="checkbox" id="checkbox" class="custom-control-input">
                <span class="custom-control-indicator"></span>
                <span class="custom-control-description">同意协议</span>
            </label>
        </div>
        <button id="button" type="submit" class="btn btn-primary">注册</button>
    </form>
    <div class="card-footer">
        <a href="login" class="small">已有账号去登陆</a>
    </div>
</div>

<script src="js/base.js" defer></script>
<script>
    const usernameInput = document.querySelector("#username");
    const emailInput = document.querySelector("#email");
    const validCodeInput = document.querySelector("#valid");
    const checkBox = document.querySelector("#checkbox");
    const button = document.querySelector("button");
    const yzmCanvas = document.querySelector("#validcanvas");
    const emailHint = document.querySelector("#email-hint");

    const emails = ['@qq.com', '@163.com', '@126.com', '@gmail.com', '@hotmail.com'];

    let usernameState = false;
    let emailState = false;

    window.addEventListener("load", function () {
        createYZM(yzmCanvas)
    });

    function validInput() {
        if (!usernameState) {
            usernameInput.setCustomValidity("用户名不可用");
            return false;
        } else {
            usernameInput.setCustomValidity("")
        }

        if (!emailState) {
            emailInput.setCustomValidity("email不可用");
            return false;
        } else {
            emailInput.setCustomValidity("")
        }

        if (!checkValid()) {
            validCodeInput.setCustomValidity("验证码错误");
            return false;
        } else {
            validCodeInput.setCustomValidity("");
        }

        return true;
    }

    validCodeInput.addEventListener("keyup", function () {
        checkValid()
    });

    checkBox.addEventListener("change", function () {
        button.disabled = !checkBox.checked;
    });

    usernameInput.addEventListener("keyup", function () {
        usernameState = false;
        if (usernameInput.className !== "form-control") {
            setUserNameEmailState(this, 0);
        }
    });

    usernameInput.addEventListener("change", function () {
        console.log(usernameInput.value);
        usernameState = false;
        checkUsername(usernameInput.value);
    });

    emailInput.addEventListener("keyup", function () {
        emailState = false;
        if (emailInput.className !== "form-control") {
            setUserNameEmailState(this, 0);
        }
        let val = emailInput.value;
        if (val.length > 2 && val.endsWith('@'))
            emailHint.innerHTML = `${emails.map(email => `<option value="${val.substr(0, val.indexOf('@')) + email}"/>`).join('')}`
    });
    emailInput.addEventListener("change", function () {
        emailState = false;
        checkEmail(emailInput.value);
    });

    //0-clear -1-error 1-success
    function setUserNameEmailState(node, state) {
        if (state === -1) {
            node.parentNode.className = "col-sm-9 has-danger";
            node.className = "form-control form-control-danger";
            node.title = "不可用";
        } else if (state === 1) {
            node.parentNode.className = "col-sm-9 has-success";
            node.className = "form-control form-control-success";
            node.title = "可用";
        } else {
            node.parentNode.className = "col-sm-9";
            node.className = "form-control";
            node.title = "";
        }
    }

    function checkUsername(username) {
        if (!usernameInput.checkValidity()) {
            return;
        }
        Api.checkUsername(username, function (isok) {
            usernameState = isok;
            setUserNameEmailState(usernameInput, isok ? 1 : -1);
        });
    }

    function checkEmail(email) {
        if (!emailInput.checkValidity()) {
            return
        }
        Api.checkEmail(email, function (isok) {
            emailState = isok;
            setUserNameEmailState(emailInput, isok ? 1 : -1);
        });
    }

    let code = [];

    function checkValid(valid) {
        valid = validCodeInput.value;
        console.log(valid.length);
        if (valid.length === 4) {
            for (let i = 0; i < 4; i++) {
                if (valid[i].toUpperCase() !== code[i]) {
                    break;
                }
                if (i === 3) {
                    validCodeInput.parentNode.className = "col-sm-9 row has-success";
                    validCodeInput.className = "form-control form-control-success";
                    validCodeInput.title = "";
                    return true
                }
            }
        }
        validCodeInput.parentNode.className = "col-sm-9 row has-danger";
        validCodeInput.className = "form-control form-control-danger";
        validCodeInput.title = "验证码不匹配";
        return false;
    }

    function createYZM(canvas) {
        let i;
        code.length = 0;
        const context = canvas.getContext("2d");
        context.clearRect(0, 0, canvas.width, canvas.height);

        const random = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R',
            'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
        const colors = ["red", "green", "brown", "blue", "orange", "purple", "black"];

        for (i = 0; i < 4; i++) {
            const index = Math.floor(Math.random() * 36);
            code.push(random[index]);
        }
        context.beginPath();
        // Sprinkle in some random dots
        for (i = 0; i < 10; i++) {
            let px = Math.floor(Math.random() * canvas.width);
            let py = Math.floor(Math.random() * canvas.height);
            context.moveTo(px, py);
            context.lineTo(px + 1, py + 1);
            context.strokeStyle = colors[Math.floor(Math.random() * colors.length)];
            context.lineWidth = Math.floor(Math.random() * 2);
            context.stroke();
        }

        for (i = 0; i < 2; i++) {
            //随机线条
            context.moveTo(0, Math.floor(Math.random() * canvas.height));//随机线的起点x坐标是画布x坐标0位置，y坐标是画布高度的随机数
            context.lineTo(canvas.width, Math.floor(Math.random() * canvas.height));//随机线的终点x坐标是画布宽度，y坐标是画布高度的随机数
            context.lineWidth = 0.3;//随机线宽
            context.strokeStyle = colors[Math.floor(Math.random() * colors.length)];
            context.stroke();//描边，即起点描到终点
        }

        let deg, cos, sin, dg;
        context.font = "20px Arial";
        let cx = (canvas.width - 30) / 3;
        for (i = 0; i < 4; i++) {
            context.fillStyle = colors[Math.floor(Math.random() * colors.length)];
            //产生一个正负30度以内的角度值以及一个用于变形的dg值
            dg = Math.random() * 4.5 / 10;
            deg = Math.floor(Math.random() * 60);
            deg = deg > 30 ? (30 - deg) : deg;
            cos = Math.cos(deg * Math.PI / 180);
            sin = Math.sin(deg * Math.PI / 180);

            context.save();
            context.setTransform(cos, sin + dg, -sin + dg, cos, cx * (i + 1) - 12, 18);
            context.fillText(code[i], 0, 0);
            context.restore();
        }

        canvas.onclick = function () {
            context.clearRect(0, 0, canvas.width, canvas.height);
            createYZM(canvas);
        }
    }
</script>
</body>
</html>